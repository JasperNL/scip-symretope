# Efficient propagation techniques for handling cyclic symmetries in binary programs

This is the code repository for the paper

> Jasper van Doornmalen, Christopher Hojny, "Efficient Propagation Techniques for Handling Cyclic Symmetries in Binary Programs", arXiv preprint arXiv:2203.00992 (2022).

This article discusses different techniques for handling symmetries of cyclic groups and presents numerical results comparing the effectiveness of different approaches.
The main strategy of these symmetry handling approaches is, given a symmetry group $\Gamma$ of a binary program, to enforce that only those solutions $x$ of the binary program are computed that are lexicographically maximal w.r.t. permutations $\gamma \in \Gamma$.
That is, if $\gamma(x)$ denotes the solution obtained from $x$ by permuting it according to $\gamma$, then it is enforced that $x$ is not lexicographically smaller than $\gamma(x)$ for every $\gamma \in \Gamma$, denoted $x \succeq \gamma(x)$ for all $\gamma \in \Gamma$.
To compare different symmetry handling methods, the branch-and-bound framework of the solver SCIP has been extended by novel techniques tailored for cyclic groups.
The corresponding extensions of SCIP are available in this repository.

The main contribution of this code is the constraint handler plugin `cons_symretope` for SCIP, at [src/cons_symretope.c](src/cons_symretope.c).
For cyclic groups $\Gamma$, this plugin provides propagation methods for constraints of the type $x \succeq \gamma(x)$ for all $\gamma \in \Gamma$.
The plugin has been designed to work with SCIP version v8.0.2, cf. [https://github.com/scipopt/scip/tree/v802](https://github.com/scipopt/scip/tree/v802).

The constraint handler specifies various settings. Most important is `constraints/symretope/peek`, which is `FALSE` by default and corresponds to the "weak" methods discussed in the article. If this parameter is set to `TRUE`, the corresponding "strong" propagation methods are used that find all variable fixings derivable from the constraints $x \succeq \gamma(x)$ for special cyclic groups $\Gamma$.

Besides the introduction of this new symretope constraint handler for cyclic symmetries, also automated detection and constraint creation methods are included in [src/prop_symmetry.c](src/prop_symmetry.c). If this SCIP plugin is used, this replaces the existing `prop_symmetry.c` of the original SCIP project. The most important changes are that symretope symmetry handling constraints are added in places where SCIP would add symresack constraints (which only handles $x \succeq \gamma(x)$ for a single permutation), cf. `cons_symresack.c`.

If there are multiple generators of the symmetry group such that the symmetry group is not cyclic on its own, then we add a symmetry handling constraint for each group generated by a generator of the group that is found by the symmetry detection code. We also study the case where compositions of generators are considered. This is controlled by the new parameter `propagating/symmetry/extendgenerators`.

Besides the source code of the extension of SCIP, this repository also contains the instances that are used in the experiments of the article and which are not publicly available elsewhere. These instances consist of the problem to decide whether so-called flower snark graphs admit a 3-edge coloring. Instance generators for these files are located in [generated_testsets/generate_instances.py](generated_testsets/generate_instances.py).

## Compilation

1. Compile the SCIP project with the graph automorphism code Bliss, cf. [https://github.com/scipopt/scip/tree/v802](https://github.com/scipopt/scip/tree/v802), we suggest to use `make OPT=opt LPS=spx SYM=bliss -j`.
2. Set the environment variable `SCIP_DEVELOP_PATH` to the SCIP project, or change the top line in [Makefile](Makefile).
3. Compile this project with the same build command.

## Setting files used in paper

In the [settings/](settings/) directory we present various setting files.
In the paper, we present five settings: `nosym`, `gen`, `group`, `weak` and `strong`.
For each of these variants (except the no-symmetry handling variant), we use a relabeling heuristic.

* `nosym` corresponds to `nosym`, and the associated file is [settings/settings_final_nosym.set](settings/settings_final_nosym.set);
* `gen` corresponds to `nosymretope`:
  * `original` relabeling corresponds to a `norelabel` addition in the file name: [settings/settings_final_nosymretope_norelabel.set](settings/settings_final_nosymretope_norelabel.set);
  * `max` relabeling corresponds to no addition to the settings file name, because this is the default: [settings/settings_final_nosymretope.set](settings/settings_final_nosymretope.set);
  * `min` relabeling corresponds to `min`: [settings/settings_final_nosymretope_min.set](settings/settings_final_nosymretope_min.set);
  * `respect` relabeling corresponds to `respect`: [settings/settings_final_nosymretope_respect.set](settings/settings_final_nosymretope_respect.set);
* `group` corresponds to `moresymresack`;
  * The naming for the relabeling heuristics is similar to the nosymretope setting.
* `weak` corresponds to `nopeek`;
  * The naming for the relabeling heuristics is similar to the nosymretope setting.
* `strong` corresponds to `peek`.
  * The naming for the relabeling heuristics is similar to the nosymretope setting.

We also present a comparison to isomorphism pruning, with the settings `isopr` and `isopr mib`. These are not ran using this project, but with the code from the paper

> Marc E. Pfetsch, Thomas Rehn, "A Computational Comparison of Symmetry Handling Methods for Mixed Integer Programs", Mathematical Programming Computation, 11(1), 37-93, 10.1007/s12532-018-0140-y

An older version of the isomorphism pruning code can be found at https://www2.mathematik.tu-darmstadt.de/~pfetsch/symmetries.html.
We thank Marc E. Pfetsch for providing a more recent version of the code, that we patched to work with SCIP v8.0.2.

## Testing

### Running the code for a single instance

After compilation, the binaries are placed in the `bin/`-directory.
Assuming that the program is built using gcc in OPT-mode with SoPlex (as with `make OPT=opt LPS=spx SYM=bliss -j`), the usage is as follows:

```console
usage: bin/sbcs.linux.x86_64.gnu.opt.spx2 <file> [-l <solution file>] [-w <write solution file>] [-s <setting file>] [-t <time limit>] [-m <mem limit>] [-n <node limit>] [-d <display frequency>] [-p <seed>] [-setcutoff <value>] [-O]
```

Input arguments:

* `<file>`: The problem instance in any format supported by SCIP's default readers.
* `-l <solution file>`: A solution file given by SCIP to test.
* `-w <write solution file>`: After solving, save the solution file.
* `-s <setting file>`: A setting file. See the [settings/](settings/) directory for various options.
* `-t <time limit>`: The time limit in seconds. By default no time limit is set.
* `-m <mem limit>`: Memory limit.
* `-n <node limit>`: Maximal number of branch-and-bound tree nodes before terminating.
* `-d <display frequency>`: Terminate automatically if a maximal number of nodes is discovered.
* `-p <seed>`: Seed for randomization.
* `-setcutoff <value>`: An objective value. Once reached, automatically terminate.
* `-O`: If set, only presolve the problem.

#### Example

Running the MIPLIB2010 `cov1075` instance from MIPLIB2010 with settings file `settings_peek.set`.

```console
$ bin/sbcs.linux.x86_64.gnu.opt.spx2 ~/testsets/IP/miplib2010/cov1075.mps.gz -s settings/settings_peek.set
SCIP version 8.0.2 [precision: 8 byte] [memory: block] [mode: optimized] [LP solver: Soplex 6.0.1.3] [GitHash: (5f0473c4fb)]
Copyright (C) 2002-2022 Konrad-Zuse-Zentrum fuer Informationstechnik Berlin (ZIB)

Symretope propagation methods - (c) Jasper van Doornmalen, Christopher Hojny.
[GitHash: (...)]

reading parameter file <settings/settings_peek.set> ...

Changed settings:
misc/usesymmetry = 1
propagating/symmetry/addsymresacks = TRUE


solving problem ...

original problem has 120 variables (120 bin, 0 int, 0 impl, 0 cont) and 637 constraints
feasible solution found by trivial heuristic after 0.0 seconds, objective value 1.200000e+02

[...]
```

### Cluster script

In [testsfinal.inst](testsfinal.inst) we list the testsets (from the `check/testset` directory), and the settings (from the `settings` directory) with which the tests are run.
The bash scripts `run_tests_performance.sh` parse the instances and run them on a HPC cluster with a slurm job manager system, using the test scripts from the `check/` directory.

The code is also compatible with the default testing mechanisms of SCIP, using the `testcluster` in the Makefile command. For more information on that, we refer to https://scipopt.org/doc/html/TEST.php .

### Problem instances

We present two classes of problem instances:

* `final_flowersnark`: 3-edge colouring of flower snark graphs. Flower snark graphs have dihedral symmetries. There exist large cyclic subgroups. There is no 3-edge colouring of these graphs.
* `final_miplib_symretope_if_extended_generating_set_cpx_v802`: Instances from MIPLIB 2010 and MIPLIB 2017 for which symretopes constraints are added.

The testsets locations are in [check/testset/](check/testset/).
The flower snark instances are included in this repository.
The MIPLIB instances, the paths are in [check/testset/final_miplib_symretope_if_extended_generating_set_cpx_v802.test](check/testset/final_miplib_symretope_if_extended_generating_set_cpx_v802.test).
The paths to the instances are absolute and need to be adapted to your local paths.
The test set instances can be downloaded from [https://miplib.zib.de/download.html](https://miplib.zib.de/download.html) and [https://miplib2010.zib.de/](https://miplib2010.zib.de/).

## Results

The results are placed in `check/results/`.
Past results and analyzing scripts are located at [../analyze/](../analyze/).
We refer to [../analyze/README.md](../analyze/README.md) for more details.
